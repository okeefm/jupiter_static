<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
      html { height: 100% }
      body { height: 100%; margin: 0; padding: 0 }
      #map-canvas { height: 100% }
    </style>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD1IdBMF8aX6BZUbWL5pHWZ3DAq1dETL_g&sensor=false"></script>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
	<script src="http://code.jquery.com/jquery-migrate-1.2.1.min.js"></script>
	<script src="js/geoxml3.js"></script>
	<script src="js/ProjectedOverlay.js"></script>
	
    <script type="text/javascript">
		var map;
		var markers = [];
		var centerLat = null;
		var centerLon = null;
		var base_url = "http://localhost/jupiter_static/"
		if (param("radius") != null) {
			radius = parseInt(param("radius"));
		} else {
			var radius = 32;
		}
      function initialize() {
		$.get("https://maps.googleapis.com/maps/api/geocode/json?sensor=false&address=" + param("zip"), function(data) {
			centerLat = data.results[0].geometry.location.lat;
			centerLon = data.results[0].geometry.location.lng;
			var mapOptions = {
			  center: new google.maps.LatLng(centerLat, centerLon),
			  zoom: 10
			};
			map = new google.maps.Map(document.getElementById("map-canvas"),
				mapOptions);
				
			/*var ctaLayer = new google.maps.KmlLayer({
				url: 'http://okeefm.dyndns-home.com/okeefm/hikingtrails.kml'
			  });
			ctaLayer.setMap(map);*/
			
			loadAdditionalData();
			
			var myParser = new geoXML3.parser({map: map, zoom: false, singleInfoWindow: true});
			myParser.parse('recreation_data/hikingtrails.kml');
			//myParser.parse('recreation_data/biketrails.kml');
		});

      }
      google.maps.event.addDomListener(window, 'load', initialize);
	  
	  function loadAdditionalData() {
		  $.getJSON("recreation_data/state_parks.json", function(data) {
			$.each(data.data, function(index, elem) {
				if (getDistanceFromLatLonInKm(centerLat, centerLon, elem[21], elem[20]) < radius) {
					var latLng = new google.maps.LatLng(elem[21], elem[20]); 
					// Creating a marker and putting it on the map
					var marker = new google.maps.Marker({
						position: latLng,
						animation: google.maps.Animation.DROP,
						title: elem[8] + " " + elem[9],
						icon: "maps_markers/darkgreen_markerS.png"
					});
					marker.setMap(map);
				}
			});
		  });
		  
		  var infowindow = new google.maps.InfoWindow();
		  
		  $.getJSON("recreation_data/todos_outdoors.json", function(data) {
			$.each(data.data, function(index, elem) {
				if (getDistanceFromLatLonInKm(centerLat, centerLon, elem[18][1], elem[18][2]) < radius) {
					var latLng = new google.maps.LatLng(elem[18][1], elem[18][2]); 
					// Creating a marker and putting it on the map
					var marker = new google.maps.Marker({
						position: latLng,
						animation: google.maps.Animation.DROP,
						title: elem[10],
						icon: "maps_markers/darkgreen_markerT.png"
					});
					
					google.maps.event.addListener(marker, 'click', function() {
						infowindow.close();
						if (elem[16][0] == null) {
							var link_str = "";
						} else {
							var link_str = "<div>Link: <a href='"+ elem[16][0]+ "' target='_blank'>" + elem[16][0] + "</a></div>";
						}
						if (elem[16][1] == null) {
							var imgString = "";
						} else {
							var imgString = "<div><img src='"+ elem[16][1] +"' /></div>";
						}
						var contentString = "<h3>" + elem[10] + "</h3><div>" + elem[11] + "</div>" + imgString + link_str;
						infowindow = new google.maps.InfoWindow({
							content: contentString
						});
						infowindow.open(map, marker);
					});
					marker.setMap(map);
				}
			});
		  });
	  }
	
	function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
	  var R = 6371; // Radius of the earth in km
	  var dLat = deg2rad(lat2-lat1);  // deg2rad below
	  var dLon = deg2rad(lon2-lon1); 
	  var a = 
		Math.sin(dLat/2) * Math.sin(dLat/2) +
		Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
		Math.sin(dLon/2) * Math.sin(dLon/2)
		; 
	  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
	  var d = R * c; // Distance in km
	  return d;
	}

	function deg2rad(deg) {
	  return deg * (Math.PI/180)
	}
	
	function param(name) {
		var prmstr = window.location.search.substr(1);
		var prmarr = prmstr.split ("&");
		var params = {};

		for ( var i = 0; i < prmarr.length; i++) {
			var tmparr = prmarr[i].split("=");
			params[tmparr[0]] = tmparr[1];
		}
		return params[name];
	}
    </script>
  </head>
  <body>
    <div id="map-canvas" style="height:95%;" />
  </body>
</html>